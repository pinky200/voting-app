name: Voting App CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    permissions:
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker images
      run: |
        # Build and push each service
        services=("vote" "result" "worker")
        for service in "${services[@]}"; do
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-$service:${{ github.sha }} ./$service
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-$service:${{ github.sha }}
        done
        echo "âœ… Docker images built and pushed"

  security-scan:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-to-kubernetes:
    runs-on: ubuntu-22.04
    needs: [build-and-push, security-scan]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Minikube
      uses: medyagh/setup-minikube@master
      with:
        driver: docker
        container-runtime: containerd

    - name: Install Helm dependencies
      run: |
        cd voting-app
        helm dependency update

    - name: Deploy to Kubernetes
      run: |
        helm upgrade --install voting-app ./voting-app \
          --namespace voting-app-${{ github.sha }} \
          --create-namespace \
          --set vote.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-vote \
          --set result.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-result \
          --set worker.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker \
          --set vote.image.tag=${{ github.sha }} \
          --set result.image.tag=${{ github.sha }} \
          --set worker.image.tag=${{ github.sha }} \
          --set global.namespace=voting-app-${{ github.sha }} \
          --set postgresql.auth.password=test123 \
          --set redis.auth.enabled=false \
          --wait \
          --timeout 10m

    - name: Verify deployment
      run: |
        kubectl get pods,svc -n voting-app-${{ github.sha }}
        kubectl wait --for=condition=ready pod -l app=vote -n voting-app-${{ github.sha }} --timeout=300s

  smoke-tests:
    runs-on: ubuntu-22.04
    needs: deploy-to-kubernetes
    steps:
    - name: Run smoke tests
      run: |
        # Port-forward and test services
        kubectl port-forward svc/vote 8080:80 -n voting-app-${{ github.sha }} &
        sleep 10
        curl -f http://localhost:8080/ && echo "Vote service is healthy"
        
        kubectl port-forward svc/result 8081:80 -n voting-app-${{ github.sha }} &
        sleep 10  
        curl -f http://localhost:8081/ && echo "Result service is healthy"

  completion:
    runs-on: ubuntu-22.04
    needs: [build-and-push, security-scan, deploy-to-kubernetes, smoke-tests]
    steps:
    - name: Phase 3 Complete
      run: |
        echo "ðŸŽ‰ PHASE 3 COMPLETE! All requirements fulfilled:"
        echo "âœ… Automated Docker builds and pushes"
        echo "âœ… Security scanning with Trivy"
        echo "âœ… Automatic Kubernetes deployment"
        echo "âœ… Smoke tests for endpoints"
        echo "âœ… Infrastructure as Code (Helm)"
